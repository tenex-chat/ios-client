default_platform(:ios)

platform :ios do
  desc "Push a new release build to the App Store"
  lane :release_testflight do
    # setup_ci if you are using CI
    setup_ci

    # -------------------------------------------------------------------------
    # Code Signing (Match)
    # -------------------------------------------------------------------------
    # Uncomment the following block to use 'match' for code signing.
    # This is highly recommended for CI/CD.
    # Ensure you have run 'fastlane match init' and 'fastlane match appstore' locally first.
    #
    # match(
    #   type: "appstore",
    #   readonly: true
    # )
    # -------------------------------------------------------------------------

    # Build the app
    # We pass the build number (GitHub Run Number) via xcargs to avoid modifying generated files.
    # MARKETING_VERSION is set to 1.0.0 by default if not specified.
    # You can update this to fetch from a file or environment variable.
    build_app(
      scheme: "TENEX",
      export_method: "app-store",
      clean: true,
      include_bitcode: true,
      include_symbols: true,
      xcargs: "CURRENT_PROJECT_VERSION=#{ENV["GITHUB_RUN_NUMBER"]} MARKETING_VERSION=1.0.0"
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end
end
